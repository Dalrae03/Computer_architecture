# 4단원 - CPU의 작동 원리

## ALU와 제어장치

- **산술연산장치 (ALU)**

→ CPU 내부에서 레지스터와 제어장치로부터 받아들인 피연산자와 제어 신호로 산술 연산, 논리 연산 등 다양한 연산을 수행하는 장치<br>
(CPU 내부: ALU, 레지스터, 제어 장치)

<br>

<u>받아들이는 정보</u>: 레지스터를 통해 피연산자, 제어장치로 부터 제어신호

<u>내보내는 정보</u>: 레지스터에 결괏값, 플래그 레지스터에 플래그

<br>

- 플래그

→ 연산 결과에 대한 추가적인 상태 정보

대표적: 부호 플래그, 제로 플래그, 캐리 플래그, 오버플로우 플래그, 인터럽트 플래그, 슈퍼바이저 플래그

플래그들은 <u>플래그 레지스터</u>에 저장

→ 플래그 레지스터들은 기본값 ‘0’. ‘1’로 바뀔 경우 해당 플래그가 적용됐다는 소리

<br>

+) 오버 플로우

→ 연산 결과가 연산결과를 담을 레지스터보다 큰 상황

<br>
<br>

- **제어장치**

→ 제어 신호를 내보내고 명령어를 해석하는 부품

제어 신호: 컴퓨터 부품들을 관리하고 작동시키기 위한 일종의 전기 신호

<br>

<u>받아들이는 정보</u>: 클럭 신호, 명령어 레지스터에서 해석할 명령어, 플래그 레지스터에서 플래그 값, 제어버스를 통해 외부로 부터 전달된 제어 신호 등

<u>내보내는 정보</u>: CPU외부에 전달하는 제어신호, CPU내부에 전달하는 제어신호

<br>

<u>CPU외부에 전달하는 제어신호 </u> ⇒ 제어버스로 제어신호를 내보낸다. (메모리에 전달, (보조기억장치 포함) 입출력장치에 전달)

<u>CPU내부에 전달하는 제어신호</u> ⇒ ALU 전달 제어 신호 (수행할 연산 지시), 레지스터에 전달하는 제어 신호 (레지스터 간 데이터 이동시키거나 레지스터에 저장된 명령어를 해석하기 위해).

<br>

+) 클럭 - 컴퓨터의 모든 부품을 일사불란하게 움직일 수 있게 하는 시간 단위

<br>
<br>
<br>

## 레지스터

- **레지스터**

→ 프로그램 속 명령어와 데이터가 실행 전후로 저장되는 CPU 내부의 작은 임시 저장 장치

<br>

- 레지스터의 종류
    - 프로그램 카운터 (명령어 포인터) - 메모리에서 읽어들일 명령어의 주소 저장
    - 명령어 레지스터 - 방금 메모리에서 읽어 들인 명령어를 저장하는 레지스터 (제어장치는 명령어 레지스터 속 명령어를 받아들이고 해석한뒤 제어신호를 내보낸다)
    - 메모리 주소 레지스터 - 메모리의 주소 저장
    - 메모리 버퍼 레지스터 (메모리 데이터 레지스터) - 메모리와 주고받을 값 (데이터와 명령어)을 저장하는 레지스터
    - 범용 레지스터 - 데이터와 주소를 모두 저장할 수 있는 일반적인 상황에서 자유롭게 사용할 수 있는 레지스터
    - 플래그 레지스터 - 연산결과 or CPU상태에 대한 부가적인 정보를 저장

<br>

- 대강의 과정

프로그램 카운터 → 메모리 주소 레지스터 → 메모리 주소 레지스터와 제어신호가 메모리로 감 → 메모리에서 데이터를 읽어서 메모리 버퍼 레지스터로 감, 프로그램 카운터는 주소 번호 증가 (다음 명령어 읽어 들일 준비) → 메모리 버퍼 레지스터의 값이 명령어 레지스터로 → 제어장치는 명령어 레지스터의 명령어 해석, 제어신호 발생 

<br>
<br>

### 특정 레지스터를 이용한 주소 지정 방식

- **스택 주소 지정 방식**

→ 스택과 스택 포인터(스택에 마지막으로 저장한 값의 위치를 저장하는 레지스터)를 이용한 주소 지정 방식

<br>

스택 영역: 메모리 안에 스택처럼 사용할 영역이 정해진 곳

<br>
<br>

- **변위 주소 지정 방식**

→ 오퍼랜드 필드의 값과 특정 레지스터 값을 더해 유효 주소를 얻어내는 방식

오퍼랜드 필드의 주소와 어떤 레지스터를 더하는지에 따라 상대 주소 지정 방식, 베이스 레지스터 주소 지정 방식 등으로 나뉨

<br>

- 명령어 구조

| 연산코드 | 레지스터 | 오퍼랜드 |
| --- | --- | --- |
| 이런 내용을 수행해라 | 이 레지스터 값과 | 이 주소를 더한 곳에 있는 데이터로 |

<br>

- <u>상대 주소 지정 방식</u>

→ 오퍼랜드와 프로그램 카운터의 값을 더하여 유효주소를 얻는 방식

프로그램 카운터의 값을 기준으로 오퍼랜드의 수만큼 앞뒤로 이동한 번지 레지스터를 실행.

분기하여 특정 주소의 코드를 실행할 때 사용

<br>

- <u>베이스 레지스터 주소 지정 방식</u>

→ 오퍼랜드와 베이스 레지스터의 값을 더하여 유효주소를 얻는 방식

베이스 레지스터 안의 기준 주소에 오퍼랜드 값만큼의 떨어진 번지의 코드 실행.

<br>
<br>
<br>

## 명령어 사이클과 인터럽트
<br>

- **명령어 사이클**

→ 하나의 명령어가 처리되는 주기. (하나의 명령어를 처리하는 정형화된 흐름)

<br>

- 구성
    - 인출 사이클 - 메모리에 있는 명령어를 CPU로 가지고 오는 단계
    - 실행 사이클 - CPU로 가져온 명령어를 실행하는 단계 (제어장치가 명령어 레지스터에 담긴 값을 해석하고, 제어 신호를 발생시키는 단계)
    - 간접 사이클 - 명령어를 CPU로 가지고왔다고 하더라도 명령어가 간접 주소 지정 방식같은 방식일 경우 명령어를 시행하기 위해서는 메모리 접근을 한 번 더 해야하는데, 그 단계
    - 인터럽트 사이클 - 인터럽트가 발생했을 경우에 실행되는 단계

<br>
<br>

### 인터럽트

→ CPU의 정상적인 작업을 방해하는 신호. (흐름이 끊어지는 상황)

⇒ CPU가 꼭 주목해야 할 때, CPU가 얼른 처리해야할 다른 작업이 생겼을 때

<br>

![인터럽트](2단원%20-%20인터럽트.png)

<br>

- 종류
    - **동기 (= 예외)** - CPU에 의해 발생 (예상치 못한 상황. ex/ CPU가 실행하는 프로그래밍 상의 오류)
    - **비동기 (= 하드웨어 인터럽트)** - 입출력장치에 의해 발생.

<br>

- **하드웨어 인터럽트**

→ 입출력장치가 어떠한 입력을 받아들였을 때 이를 처리하기 위해 CPU입력알림 (인터럽트) 을 보냄

세탁기 완료 알림, 전자레인지 조리 완료 알림과 같이 알림 역할을 하는 인터럽트

CPU는 프린터로부터 프린트 완료 인터럽트를 받을 때까지 다른 작업을 처리할 수 있음 (효율적 명령어 처리 가능)

<br>

- 순서
    1. 입출력장치가 CPU에 <U>인터럽트 요청신호</U>를 보냄
    2. CPU는 실행 사이클이 끝나고 명령어를 인출하기 전 항상 인터럽트 여부 확인
    3. CPU는 인터럽트 요청 확인. <u>인터럽트 플래그</u>를 통해 현재 인터럽트를 받아들일 수 있는지 여부 확인
    4. 인터럽트를 받아들일 수 있다면 CPU는 지금까지의 작업을 백업
    5. CPU는 <u>인터럽트 벡터</u>를 참조하여 <u>인터럽트 서비스 루틴</u>을 실행
    6. 인터럽트 서비스 루틴 실행이 끝나면 4에서 백업해 둔 작업을 복구하여 실행을 재개

<br>

- <u>인터럽트 플래그</u> - 하드웨어 인터럽트를 받아들일지, 무시할지를 결정하는 플래그

인터럽트 플래그가 불가능으로 설정되어있다면 CPU는 인터럽트 요청이 오더라도 해당 요청 무시

인터럽트 플래그가 불가능으로 설정되어 있을지라도 무시할 수 없는 인터럽트 요청

⇒ 가장 우선순위가 높은, 가장 먼저 처리해야 하는 인터럽트 (정전이나 하드웨어 고장으로 인한 인터럽트)

<br>

- <u>인터럽트 서비스 루틴 (인터럽트 핸들러)</u> - 인터럽트를 어떻게 처리하고 작동해야 할지에 대한 정보로 이루어진 프로그램 (명령어와 데이터로 이루어져있다 → 프로그램 카운터를 비롯한 레지스터들을 사용하며 실행된다)
    - 인터럽트 백터 - 인터럽트 서비스 루틴을 식별하기 위한 정보. 인터럽트 서비스 루틴의 시작 주소를 알 수 있다.

<br>

인터럽트가 발생하기 전까지 레지스터에 저장되어 있었던 값들 (+ 지금까지의 작업 내역, 현재 프로그램을 재개하기 위해 필요한 모든 내용들)은 스택에 백업

<br>

![사이클](2단원%20-%20사이클.png)

<br>
<br>

- **예외 (동기 인터럽트)**

CPU가 명령어들을 수행하다가 프로그래밍 오류와 같은 예상치 못한 상황에 마주쳤을 때 발생하는 인터럽트

<br>

- 종류
    - 폴트 - 예외를 처리한 직후 예외가 발생한 명령어부터 실행을 재개하는 예외
    - 트랩 - 예외를 처리한 직후 예외가 발생한 명령어의 다음 명령어부터 실행을 재개하는 예외 (주로 디버깅 할 때 사용)
    - 중단 - CPU가 실행 중인 프로그램을 강제로 중단시킬 수밖에 없는 심각한 오류를 발견했을 때
    - 소프트웨어 인터럽트 - 시스템 호출이 발생했을 때